@page "/lineups/{lineupId:int}/{artistId:int}/add-performance"

@layout LineupLayout

@inject IArtistService ArtistApiService
@inject ILineupService LineupApiService
@inject IPerformanceService PerformanceApiService

@inject NavigationManager NavigationManager

<h3>Add performance</h3>

@if(_lineupResult is { } lineupResult && _artistResult is { } artistResult)
{
    <EditForm Model="_model" OnValidSubmit="AddPerformance">
        <CreateEditPerformance Model="_model"></CreateEditPerformance>

        <div>
            <InputNumber @bind-Value="_model.LineupId" hidden />
            <p>@(lineupResult.Name ?? lineupResult.Doors.ToLongDateString()) (id: @_model.ArtistId))</p>
        </div>

        <div>
            <InputNumber @bind-Value="_model.ArtistId" hidden />
            <p>@artistResult.Name (id: @_model.ArtistId)</p>
        </div>

        <ul>
            <li><button type="submit">Add</button></li>
        </ul>
    </EditForm>
}

@code {
    [Parameter]
    public int LineupId { get; set; }
    private LineupResult? _lineupResult;

    [Parameter]
    public int ArtistId { get; set; }
    private ArtistResult? _artistResult;

    private CreateEditLineupPerformanceFormModel _model = new();

    protected override async Task OnParametersSetAsync()
    {
        var artistServiceResult = await ArtistApiService.Get(ArtistId);
        if(artistServiceResult.Data is not { } artistResult)
        {
            return;
        }
        _artistResult = artistResult;
        _model.ArtistId = artistResult.Id;


        var lineupServiceResult = await LineupApiService.Get(LineupId, new PaginationRequest { Page = 1, PageSize = 5 });
        if(lineupServiceResult.Data is not { } lineupResult)
        {
            return;
        }
        _lineupResult = lineupResult;
        _model.LineupId = lineupResult.Id;

        await base.OnParametersSetAsync();
    }


    private async Task AddPerformance()
    {
        if(_model.ArtistId is not { } artistId)
        {
            return;
        }

        if(_model.LineupId is not { } lineupId)
        {
            return;
        }

        var serviceResult = await PerformanceApiService.Create(new PerformanceRequest { ArtistId = artistId, LineupId = lineupId, Duration = _model.Duration, Start = _model.Start, Type = _model.Type });
        if(serviceResult.Messages is null)
        {
            NavigationManager.NavigateTo($"lineups/{LineupId}/performances");
        }
    }
}